<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/font-roboto/roboto.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../bower_components/app-layout/demo/sample-content.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
  
<!-- Custom Components of the app -->
<link rel="import" href="headerMatch.html">
<link rel="import" href="drawer-matchmaker.html">
<link rel="import" href="container-matchmaker.html">

<app-location route="{{_route}}" use-hash-as-path></app-location>
    <app-route
        route="{{_route}}"
        pattern="/:page"
        data="{{_pageData}}"
        tail="{{_subRoute}}"></app-route>
    <app-route
        route="{{_subRoute}}"
        pattern="/:id"
        data="{{_idData}}"></app-route>

<dom-module id="app-main">

  <template>
    <style>
      body {
        margin: 0;
        font-family: 'Roboto', 'Noto', sans-serif;
        background-color: #eee;
      }
    </style>
    
   <!-- Request to get the currentUser -->
   <iron-ajax
      auto 
      id="menuRequest"
      url="../data/test-currentUser.json" 
      handle-as="json"
      on-response="handleCurrentUserResponse"></iron-ajax>
    
    <!-- Request to get the menuOptions of the user -->
    <iron-ajax
      auto 
      id="menuRequest"
      url="../data/test-menuOptions.json" 
      handle-as="json"
      on-response="handleMenuResponse"></iron-ajax>

    <header-matchmaker activeuser="{{user}}"> </header-matchmaker>
    
    <p> {{menuu}} </p>
    
    <drawer-matchmaker activeuser="{{user}}" menuoptions="[[menuOptions]]"></drawer-matchmaker>
    <container-matchmaker> </container-matchmaker>

  </template>
  
   <script>

  Polymer({

    is: 'app-main',

    properties: {

      _route: Object,

      _subRoute: Object,

      _pageData: {
        type: Object,
        observer: '_pageDataChanged'
      },

      _selectedPage: String,

      _idData: Object,
    
      _scrollPositionMap: {
        type: Object,
        value: function() {
          return {};
        }
      }
    },
    
    attached: function() {
        this.async(function() {
          if (!this._route.path) {
            this.set('_route.path', '/home');
          }
        });
      },

    _drawerSelected: function() {
      if (!this.$.drawer.persistent) this.$.drawer.close();
    },

    /**
     * Preserves the document scroll position, so 
     * it can be restored when returning to a page.
     */
    _pageDataChanged: function(pageData, oldPageData) {
      var map = this._scrollPositionMap;
     
      if (oldPageData != null && oldPageData.page != null) {
        map[oldPageData.page] = window.pageYOffset;
      }
      this._selectedPage = pageData.page;
      if (map[pageData.page] != null) {
        Polymer.AppLayout.scroll({ top: map[pageData.page], behavior: 'silent' });
      } else if (this.isAttached) {
        Polymer.AppLayout.scroll({ top: 0, behavior: 'silent' });
      }
    },
    
    handleCurrentUserResponse: function (data) {
    	this.user = data.detail.response;
    },
    
    handleMenuResponse: function (data) {
    	this.menuOptions = data.detail.response;
    },
    
    ready: function() {
    }
  });
  </script>

</dom-module>